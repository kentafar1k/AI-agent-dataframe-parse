# AI Agent: Google Drive Excel -> API + QA + Open WebUI

## Задача (ТЗ)
- **Уровень 1**: Составить план решения взаимодействия ИИ с Google Drive для чтения Excel.
- **Уровень 2**: Реализовать механизм взаимодействия с Google Drive и визуализацию доступа к данным через Open WebUI.
- **Уровень 3**: Создать ИИ-агента, который отвечает на вопросы на основе данных таблицы.

Таблица содержит 2 колонки:
1) название инструмента с `realtycalendar.ru` (например, "Шахматка бронирования")
2) ссылка на раздел.

Примерные вопросы: "Объясни инструмент, название которого находится в (название ячейки)".

---

## План решения (Уровень 1)
1. **Инфраструктура**: FastAPI + Docker + docker-compose, Open WebUI контейнер рядом.
2. **Авторизация к Google Drive**: сервисный аккаунт (`credentials.json`), права `drive.readonly`, доступ к нужной папке/файлам.
3. **Чтение Excel**: скачивание файла по `file_id` из Google Drive, парсинг через `pandas`/`openpyxl`, нормализация к схеме `[ { tool_name, url } ]`.
4. **API**:
   - `/health` — статус
   - `/drive/files` — список Excel-файлов
   - `/drive/files/{file_id}` — проверка доступа (размер)
   - `/table/read?file_id=&sheet_name=` — чтение таблицы
   - `/table/cell?file_id=&cell=&sheet_name=` — чтение ячейки
   - `/qa/ask?file_id=&question=` — ответ по данным таблицы
5. **Open WebUI**:
   - Запускается отдельным сервисом в compose.
   - Можно использовать для чатов и простого UX, прокинуть API-эндпоинты как источник данных/тул.
6. **ИИ-агент**: базовая логика — фуззи-поиск по названию инструмента и формирование ответа с ссылкой. (Можно заменить/дополнить LLM.)

---

## Быстрый старт

### Подготовка
1. Установите Docker и Docker Compose.
2. Получите `credentials.json` сервисного аккаунта Google (роль: доступ к чтению Drive). Поделитесь нужной таблицей на адрес сервисного аккаунта.
3. Сохраните файл `credentials.json` в корень проекта и убедитесь, что он будет смонтирован в контейнер (`docker-compose.yml`).
4. Создайте `.env` по образцу `.env.example` (опционально).

### Запуск
```bash
docker compose up --build
```
- API: `http://localhost:8000/docs`
- Open WebUI: `http://localhost:8080`

### Переменные окружения
- `GOOGLE_APPLICATION_CREDENTIALS=/app/credentials.json` (по умолчанию так)

---

## API Обзор
Откройте `http://localhost:8000/docs` для Swagger UI.

Примеры (см. `test_main.http`):
- `GET /health` — проверка статуса
- `GET /drive/files` — список Excel файлов (можно `?q=...`)
- `GET /drive/files/{file_id}` — проверка доступа, размер
- `GET /table/read?file_id=...&sheet_name=` — вернуть список `{ tool_name, url }`
- `GET /table/cell?file_id=...&cell=A1` — значение ячейки
- `POST /qa/ask?file_id=...&question=...` — ответ по данным таблицы

Ожидаемый формат таблицы: первые 2 колонки — название инструмента и ссылка.

---

## Open WebUI (Уровень 2)
- Контейнер `openwebui` запускается вместе с API.
- Варианты интеграции:
  - Использовать UI как чат и отправлять вопросы на наш эндпоинт `/qa/ask` через кастомную кнопку/плагин.
  - Или проксировать ответы через простой бекенд-обработчик.
- Для демо достаточно показать: WebUI работает и параллельно есть API, где данные реально читаются из Google Drive.

---

## ИИ-агент (Уровень 3)
- Текущая реализация: фуззи-поиск по названию инструмента в вопросе (difflib) и генерация ответа со ссылкой, если инструмент найден.
- Улучшения (по желанию):
  - Подключить LLM (OpenAI, локальные модели через Open WebUI) для переформулирования и поиска.
  - Рерэнкинг по векторному поиску (FAISS) по колонке с названиями.
  - Кэширование таблицы, контроль версий.

---

## Презентация результата
1. Кратко рассказать план (раздел выше), показать контейнеры и `.env`/`credentials.json`.
2. Показать `GET /drive/files` — видим файлы.
3. Взять `file_id` существующего Excel, показать `GET /table/read` — видим 2 колонки.
4. Задать вопрос в `/qa/ask` (например: "Объясни инструмент, название которого находится в (A1)") — получить ответ.
5. Открыть Open WebUI и показать, что UX доступен для диалога.

---

## Структура проекта
```
app/
  main.py               # фабрика FastAPI + роутеры
  routers/
    health.py
    drive.py
    table.py
    qa.py
  services/
    gdrive.py           # доступ к Google Drive
    table_reader.py     # чтение/нормализация Excel
    qa_agent.py         # простая логика ответа
Dockerfile
docker-compose.yml
requirements.txt
main.py                 # экспорт app для uvicorn
test_main.http          # примеры запросов
```

---

## Нюансы и безопасность
- Сервисный аккаунт должен иметь доступ к нужным файлам/папкам (расшарьте файл).
- В проде используйте секреты вместо простого монтирования `credentials.json`.
- Обработайте лимиты Google API и ретраи при ошибках сети.

---

## Развитие
- Добавить авторизацию на API.
- Индексация таблицы и кэш.
- Подключение LLM с провайдером по требованию.




